<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="../visualiser_dataset.js" charset ='utf-8'> </script>
<script>
const PI     = "3.141592653589793238462643383279502884197169399375105820974944592307816406286208998628034825342117067";
const pi1000 = "3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989";
const width  = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
const height = window.innerHeight|| document.documentElement.clientHeight|| document.body.clientHeight;

window.addEventListener('load', function () {
    console.log('This function is executed once the page is fully loaded');
    console.log(PI);
    placeBraces();
});

var newDiv = document.createElement("div");
newDiv.className = "pi_text";
var newContent = document.createTextNode(pi1000);

newDiv.appendChild(newContent);

var currentDiv = document.getElementById("div1");
document.body.insertBefore(newDiv, currentDiv);

document.onwheel = function(event) {
    if (event.deltaY != 0) {
        window.scrollBy(event.deltaY, 0);
    }
}

//Function from https://stackoverflow.com/questions/43965616/getting-character-width-in-javascript
var calculateWordDimensions = function(text, classes, escape) {
    classes = classes || [];

    if (escape === undefined) {
        escape = true;
    }

    classes.push('textDimensionCalculation');

    var div = document.createElement('div');
    div.setAttribute('class', classes.join(' '));

    div.innerHTML = text;


    document.body.appendChild(div);

    var dimensions = {
        width : jQuery(div).outerWidth(),
        height : jQuery(div).outerHeight()
    };

    div.parentNode.removeChild(div);

    return dimensions;
};

function test() {
var dimensions = calculateWordDimensions('42 is the answer!'); <!--obviously a hitchhikers guide fan, lol --->

console.log(dimensions.width);
};

function placeBars() {
    var inputText = newDiv;
    var innerHTML = inputText.innerHTML;
    var fudgeFactor = 15

    for (var i = 0; i < locations.length; i++) {
        var startIndex = locations[i][0] + 1;
        var stopIndex = locations[i][1] + 1;

        var startStr = innerHTML.substring(0, startIndex);
        var codeStr = innerHTML.substring(startIndex, stopIndex);

        var barPos = calculateWordDimensions(startStr);
        var barWidth = calculateWordDimensions(codeStr).width;

        if (i % 2 == 0) {
            var ypos = (height / 2);
        } else {
            var ypos = (height / 2) + barPos.height;
        }
        generateBar(barPos.width + fudgeFactor, barPos.width + barWidth, ypos);
    }
}

function generateBar(startPoint, endPoint, height) {
    var newBar = "";
    newBar += "<div style='position:absolute;left:";
    newBar += startPoint;
    newBar += "px;top:";
    newBar += height;
    newBar += "px;width:";
    newBar += endPoint - startPoint;
    newBar += "px;height:1px;background:#000'></div>";
    document.body.innerHTML += newBar;
}

function placeBraces() {
    var inputText = newDiv;
    var innerHTML = inputText.innerHTML;
    var fudgeFactor = 15

    var svg = document.createElementNS(null, "svg");

    for (var i = 0; i < dataset.length; i++) {
        var startIndex = dataset[i]['location'][0] + 1;
        var stopIndex = dataset[i]['location'][1] + 1;
        var codeStr = innerHTML.substring(startIndex, stopIndex);
        var startStr = innerHTML.substring(0, startIndex);

        var barPos = calculateWordDimensions(startStr);
        var barWidth = calculateWordDimensions(codeStr).width;

        makeCurlyBraceReal(i, barPos.width, barWidth, i % 2 == 1, i % 3);
    }
}

window.onresize = onResizeEvent;

function onResizeEvent() {
    for (var i = 0; i < locations.length; i++) {
        var el = document.getElementById("bracket-" + i);
        if (el) {
            el.parentNode.removeChild(el);
        }
    }
    
    var el = document.getElementById("doujin_info");
    if (el) {
        el.parentNode.removeChild(el);
    }

    placeBraces();
}

function createThumbnailElement(mediaID, imgWidth) {
    var thumbnail = document.createElement("img");
    thumbnail.setAttribute("src", "https://t.nhentai.net/galleries/" + mediaID + "/cover.jpg");
    thumbnail.setAttribute("id", "overlay_thumnail");
    thumbnail.setAttribute("width", imgWidth + "px"); 
    thumbnail.setAttribute("style", "text-align:center; margin: 0px;");
    return thumbnail
}


function createInfoDivInternals(key, div, text_at_top, imgWidth) {
    div.setAttribute("class", "item");
    var thumbnail = createThumbnailElement(dataset[key]['media_id'], imgWidth);
        
    var link = document.createElement("a");
    link.setAttribute("href", "https://nhentai.net/g/" + dataset[key]['key']);
    link.appendChild(thumbnail);
    
    var title = document.createElement("p");
    title.innerHTML += dataset[key]['title'];
    
    var style = "text-align: center; font-size: 1.5vmax; margin: 0px; align:center;";
    title.setAttribute("style", style);
    
    if (text_at_top) {
        div.appendChild(title);
        div.appendChild(link);
    } else {
        div.appendChild(link);
        div.appendChild(title);
    }
}

function changeDef(event){
    var prev_el = document.getElementById("doujin_info");
    if (prev_el) {
        prev_el.parentNode.removeChild(prev_el);
    }
    
    key = parseInt(event.target.id.split('-')[1]);
    
    var doujin_info = document.createElement("div");
    doujin_info.setAttribute("id", "doujin_info");
    
    var place_div_on_top = key % 2 == 0;
    
    createInfoDivInternals(key, doujin_info, place_div_on_top, event.target.offsetWidth);
    
    var style = "";
    if (place_div_on_top) {
        style += "position: absolute; bottom: ";
        style += 5;
    } else {
        style += "position: absolute; top: ";
        style += 5;
    }
    style += "vmax; left: "
    style += event.target.offsetLeft - 0.10 * event.target.offsetWidth;
    style += "px; width: ";
    style += event.target.offsetWidth * 1.20;
    style += "px; text-align: center;"
    doujin_info.setAttribute("style", style);
    
    
    
    newDiv.appendChild(doujin_info);
}


function makeCurlyBraceReal(id, xpos, width, isBottom, colour){
    var newBrace = document.createElement('img');
    newBrace.setAttribute("src", "bracket.png");
    newBrace.setAttribute("id", "bracket-" + id);
    var style = "";
    style += "position: absolute; top: ";
    if (isBottom) {
        style += 1;
        style += "vmax; transform: rotate(180deg);"
    } else {
        style += -3;
        style += "vmax;";
    }
    style += "left: ";
    style += xpos;
    style += "px;";

    switch (colour) {
        //filtering operations calculated with this tool: https://codepen.io/sosuke/pen/Pjoqqp
        case 1: //red
            style += "filter: invert(19%) sepia(90%) saturate(5578%) hue-rotate(356deg) brightness(105%) contrast(120%);";
            break;
        case 2: //blue
            style += "filter: invert(9%) sepia(99%) saturate(7500%) hue-rotate(248deg) brightness(89%) contrast(144%);";
            break;
        default:
            //do nothing leave them as black
            break;
    }

    newBrace.setAttribute("style", style);
    newBrace.setAttribute("width", width + "px");
    newBrace.onmouseover = changeDef;
    //document.body.appendChild(newBrace);
    newDiv.appendChild(newBrace);
}
</script>

<style>
body {
    /*overflow: hidden; /* Hide scrollbars */
    min-height: 100%;
    margin: 0;
}

.highlight {
  background-color: yellow;
}

div.pi_text {
    position: absolute;
    top: 50%;
    font-size: 3vmax;
}

.textDimensionCalculation {
    position: absolute;
    visibility: hidden;
    height: auto;
    width: auto;
    white-space: nowrap;
    font-size: 3vmax;
}
</style>

</body>
</html>

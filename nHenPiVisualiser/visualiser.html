<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="visualiser_dataset.js" charset ='utf-8'> </script>
<script src="pi_digits.js"> </script>
<script>
const width  = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
const height = window.innerHeight|| document.documentElement.clientHeight|| document.body.clientHeight;

var currentEndBrace = 25;
var currentPiChunk = 0;
var lastPiWidthIndex = 0;
var lastPiWidth = 0;
var currentPiLength = 0;

function appendAnotherPiChunk() {
    if (currentPiChunk < 100) {
        currentPiChunk += 1; //Increment currentPiChunk here to prevent race condition appending multiple chunks at once
        currentPiLength += pi_digits[currentPiChunk].length;
        document.getElementById("pi_text").innerHTML += pi_digits[currentPiChunk];
    }
}

window.onbeforeunload = function () {
    currentEndBrace = 25;
    window.scrollTo(0, 0);
}

window.addEventListener('load', function () {
    placeBraces(0, currentEndBrace);
});

var newDiv = document.createElement("div");
newDiv.className = "pi_text";
var newContent = document.createElement("text")
newContent.innerHTML = pi_digits[0];
currentPiLength += pi_digits[0].length;
newContent.setAttribute("id", "pi_text");
newContent.setAttribute("style", "padding-top: 3px; padding-bottom: 3px; vertical-align: center; background-color: #1f1f1f;");

newDiv.appendChild(newContent);

var currentDiv = document.getElementById("div1");
document.body.insertBefore(newDiv, currentDiv);

function isLastBraceInViewport(endBrace) {
    var elem = document.getElementById("bracket-" + endBrace);
    if (elem) {
        var bounding = elem.getBoundingClientRect();
        return bounding.right > (window.innerWidth || document.documentElement.clientWidth);
    } else {
        return false;
    }
};

function checkToLoadMoreContent(event) {
    while(!isLastBraceInViewport(currentEndBrace - 1)) {
        if (dataset[currentEndBrace + 25]['location'][1] > currentPiLength) {
            appendAnotherPiChunk();
        }

        placeBraces(currentEndBrace, currentEndBrace + 25);
        currentEndBrace += 25;
    }
}

document.onscroll = checkToLoadMoreContent;

document.onwheel = function(event) {
    if (event.deltaY != 0) {
        window.scrollBy(event.deltaY, 0);
    }
};

//Function from https://stackoverflow.com/questions/43965616/getting-character-width-in-javascript
var calculateWordDimensions = function(text, classes, escape) {
    classes = classes || [];

    if (escape === undefined) {
        escape = true;
    }

    classes.push('textDimensionCalculation');

    var div = document.createElement('div');
    div.setAttribute('class', classes.join(' '));

    div.innerHTML = text;

    document.body.appendChild(div);

    var dimensions = {
        width : jQuery(div).outerWidth(),
        height : jQuery(div).outerHeight()
    };

    div.parentNode.removeChild(div);

    return dimensions;
};

function placeBraces(startBrace, endBrace) {
    var innerHTML = document.getElementById("pi_text").innerHTML;
    var fudgeFactor = 15

    var svg = document.createElementNS(null, "svg");

    for (var i = startBrace; i < endBrace; i++) {
        if (i == 0 && dataset[i]['location'][0] == 0) {
            var startIndex = dataset[i]['location'][0];
        } else {
            var startIndex = dataset[i]['location'][0] + 1;
        }
        var stopIndex = dataset[i]['location'][1] + 1;
        var codeStr = innerHTML.substring(startIndex, stopIndex);
        var startStr = innerHTML.substring(lastPiWidthIndex, startIndex);

        var barPos = calculateWordDimensions(startStr);
        var barWidth = calculateWordDimensions(codeStr).width;

        makeCurlyBraceReal(i, barPos.width + lastPiWidth, barWidth, i % 2 == 1, i % 3);

        if (i % 50 == 0) {
            lastPiWidthIndex = startIndex;
            if (i % 250 == 0) { //every 250 doujins do the more accurate calculation to prevent too big an error building
                lastPiWidth = calculateWordDimensions(innerHTML.substring(0, startIndex)).width;
            } else {
                lastPiWidth += barPos.width; //for most doujins just adding on the width every hundreth is enough though
            }
        }
    }
}

window.onresize = function(event){
    for (var i = 0; i < currentEndBrace; i++) {
        var el = document.getElementById("bracket-" + i);
        if (el) {
            el.parentNode.removeChild(el);
        }
    }

    var el = document.getElementById("doujin_info");
    if (el) {
        el.parentNode.removeChild(el);
    }

    currentEndBrace = 0;
    lastPiWidthIndex = 0;
    lasPiWidth = 0;
    checkToLoadMoreContent();

    //Manually replace the first bracket to make sure it is correct
    var el = document.getElementById("bracket-0");
    if (el) {
        el.parentNode.removeChild(el);
    }
    placeBraces(0, 1);
};

function handleMissingCover(image, media_id) {
    image.onerror = null;
    var req = new Request("http://192.168.0.2:5000/fetch_cover/" + media_id);
    image.src = "loading.gif";
    fetch(req).then(
        function (response) {
            image.src = "/cover_fetcher/" + media_id + ".jpg";
            console.log("Hello");
        });
}

function createThumbnailElement(mediaID, imgWidth) {
    var thumbnail = document.createElement("img");
    thumbnail.setAttribute("src", "/cover_fetcher/" + mediaID + ".jpg");
    thumbnail.setAttribute("id", "overlay_thumnail");
    thumbnail.setAttribute("width", imgWidth + "px"); 
    thumbnail.setAttribute("style", "text-align:center; margin: 0px;");
    thumbnail.setAttribute("onerror", "this.onerror=handleMissingCover(this, " + mediaID + ")");
    return thumbnail
}


function createInfoDivInternals(key, div, text_at_top, imgWidth) {
    div.setAttribute("class", "item");
    var thumbnail = createThumbnailElement(dataset[key]['media_id'], imgWidth);

    var link = document.createElement("a");
    link.setAttribute("href", "https://nhentai.net/g/" + dataset[key]['key']);
    link.appendChild(thumbnail);

    var title = document.createElement("p");
    title.innerHTML += dataset[key]['title'];

    var style = "text-align: center; font-size: 14px; margin: 0px; align:center; font-family: 'Noto Sans',sans-serif; color: #d9d9d9; font-weight: 700; padding: 3px;";
    title.setAttribute("style", style);

    if (text_at_top) {
        div.appendChild(title);
        div.appendChild(link);
    } else {
        div.appendChild(link);
        div.appendChild(title);
    }
}

function onBraceHover(event){
    //Load the cover page and title of the filth the user is currently hovering over
    var prev_el = document.getElementById("doujin_info");
    if (prev_el) {
        prev_el.parentNode.removeChild(prev_el);
    }

    key = parseInt(event.target.id.split('-')[1]);

    var doujin_info = document.createElement("div");
    doujin_info.setAttribute("id", "doujin_info");

    createInfoDivInternals(key, doujin_info, false, event.target.offsetWidth * 1.20);

    var style = "";
    if (key % 2 == 0) {
        style += "position: absolute; bottom: ";
        style += 4.75;
    } else {
        style += "position: absolute; top: ";
        style += 5;
    }
    style += "vmax; left: "
    if (key != 0) {
        style += event.target.offsetLeft - 0.10 * event.target.offsetWidth;
    } else {
        style += event.target.offsetLeft;
    }
    style += "px; width: ";
    style += event.target.offsetWidth * 1.20;
    style += "px; text-align: center; background-color: #404040;"
    doujin_info.setAttribute("style", style);

    newDiv.appendChild(doujin_info);
}


function makeCurlyBraceReal(id, xpos, width, isBottom, colour){
    var newBrace = document.createElement('img');
    newBrace.setAttribute("src", "bracket.png");
    newBrace.setAttribute("id", "bracket-" + id);
    var style = "";
    style += "position: absolute; top: ";
    if (isBottom) {
        //Bottom brace
        style += 1;
        style += "vmax; transform: rotate(180deg);"
    } else {
        //Top brace
        style += -3.5;
        style += "vmax;";
    }
    style += "left: ";
    style += xpos;
    style += "px;";

    switch (colour) {
        //filtering operations calculated with this tool: https://codepen.io/sosuke/pen/Pjoqqp
        case 1: //red
            style += "filter: invert(19%) sepia(90%) saturate(5578%) hue-rotate(356deg) brightness(105%) contrast(120%);";
            break;
        case 2: //blue
            style += "filter: invert(9%) sepia(99%) saturate(7500%) hue-rotate(248deg) brightness(89%) contrast(144%);";
            break;
        default:
            //do nothing leave them as black
            style += "filter: invert(81%) sepia(15%) saturate(0%) hue-rotate(201deg) brightness(101%) contrast(104%);";
            break;
    }

    newBrace.setAttribute("style", style);
    newBrace.setAttribute("width", width + "px");
    newBrace.onmouseover = onBraceHover;
    newDiv.appendChild(newBrace);
}

</script>

<style>
body {
    overflow-y: hidden; /* Hide scrollbars */
    min-height: 100%;
    margin: 0;
    background-color: #0d0d0d;
    font-family: 'Noto Sans',sans-serif;
    color: #d9d9d9;
    -webkit-font-smoothing: antialiased;
}

.highlight {
  background-color: yellow;
}

div.pi_text {
    position: absolute;
    top: 50%;
    font-size: 3vmax;
    font-weight: 700;
    vertical-align: center;
    background-color: #1f1f1f;
}

div.doujin_info {
    font-color: #d9d9d9;
    text-align: center;
    font-size: 1.5vmax;
    background-color: #404040;
    margin: 0px;
    align:center;
}

.textDimensionCalculation {
    position: absolute;
    visibility: hidden;
    height: auto;
    width: auto;
    white-space: nowrap;
    font-size: 3vmax;
    font-weight: 700;
}

.logo {
    position:fixed;
    top:0;
    background-color:#1f1f1f;
    width:100%;
    z-index:100;
}
</style>
<div class="logo">
    <center><img src="logo.svg" style="align:center;" width="46" height="50"/></center>
</div>
</body>
</html>
